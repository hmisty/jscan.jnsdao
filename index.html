<!DOCTYPE html>
<!--[if lt IE 7]>      <html lang="en" ng-app="ethExplorer" class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html lang="en" ng-app="ethExplorer" class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html lang="en" ng-app="ethExplorer" class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!--> <html lang="en" ng-app="ethExplorer" class="no-js"> <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>区块链浏览器</title>
  <meta name="description" content="">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <base href="/">
  <link rel="stylesheet" href="styles/main.css">
  <link rel="stylesheet" href="mirror/bootstrap/3.3.5/css/bootstrap.min.css">
  <script src="bower_components/web3/dist/web3.min.js"></script>

	<script>

		// global vars
		var __chainId, __accounts;

		function showHideConnect(chainId, accounts) {
			if (chainId) { // update chainId
				console.log('update __chainId: from ', __chainId, ' to ', chainId);
				__chainId = chainId;
			}

			if (accounts) { // update accounts
				console.log('update __accounts: from ', __accounts, ' to ', accounts);
				__accounts = accounts;
			}

			if (__chainId) { // 有网络
				if (__chainId == '0xe52' || __chainId == '0xf30') { // 3666 or 3888 已知网络
					$("#connNet")[0].innerHTML = parseInt(__chainId, 16);

					if (__accounts.length > 0) { // 有账户
						$("#connAddr")[0].innerHTML = __accounts[0].substr(0,6) + '...' + __accounts[0].substr(-4);
						$("#connLink").attr('onclick', '');
						$("#connLink").attr('href', '/address/' + __accounts[0]);
					} else { // 没有账户
						$("#connAddr")[0].innerHTML = '连接账户';
						$("#connLink").attr('onclick', 'connect()');
						$("#connLink").attr('href', '');
					}

				} else { // 未知网络
					$("#connAddr")[0].innerHTML = '未知网络';
					$("#connNet")[0].innerHTML = parseInt(__chainId, 16);
					$("#connLink").attr('onclick', 'switchNetwork()');
					$("#connLink").attr('href', '');
				}
			} else { // 没有网络
				$("#connAddr")[0].innerHTML = '';
				$("#connNet")[0].innerHTML = '?'; // no web3 found
				$("#connLink").attr('onclick', '');
				$("#connLink").attr('href', 'https://jnsdao.com/docs/joule-basics/wallet-rpc');
			}

		}

		// init to check chainId... we are waiting for body to be loaded first...
		var onBodyLoaded = function() {

			if (window.ethereum) {

				// register listeners
				window.ethereum.on('chainChanged', function (chainId) {
					console.log("[index] switched to chain id: ", parseInt(chainId, 16));
					showHideConnect(chainId, null);
				});

				window.ethereum.on('accountsChanged', function (accounts) {
					console.log("[index] switched to accounts: ", accounts);
					showHideConnect(null, accounts);
				});

				// get chain id in async way (note: window.ethereum.chainId will get null)
				window.ethereum
					.request({ method: 'eth_chainId' })
					.then((chainId) => {
						console.log(`[index] got chain id: ${parseInt(chainId, 16)}`);

						var account = window.ethereum.selectedAddress;
						var accounts = account ? [account] : [];
						console.log("[index] connected account is: ", accounts);

						showHideConnect(chainId, accounts);

					})
					.catch((error) => {
						console.error(`[index] error fetching chainId: ${error.code}: ${error.message}`);
						showHideConnect(null, null);
					});

			} else {
				console.log('showHideConnect(null, null)');
				showHideConnect(null, null);
			}
		};

		// connect to check account...
		function connect() {

			if (window.ethereum) {
				window.ethereum
					.request({ method: 'eth_requestAccounts' })
					.then((accounts) => {
						console.log("connected account is: ", accounts[0]);
						showHideConnect(null, accounts);
					})
					.catch((error) => {
						console.error(`Error requesting accounts: ${error.code}: ${error.message}`);
					});

			}
		}

		// switch network...
		function switchNetwork() {
			if (window.ethereum) {
				window.ethereum
					.request({ method: 'wallet_switchEthereumChain', 
						params: [{ chainId: '0xe52' }] })
					.catch((error) => {
						console.error(`Error switch chain: ${error.code}: ${error.message}`);
						if (error.code === 4902) { // network not added
							window.ethereum
								.request({ method: 'wallet_addEthereumChain', 
									params: [{ 
										chainId: '0xe52',
										chainName: 'Joule Mainnet',
										nativeCurrency: {
											name: 'Joule',
											symbol: 'J ',
											decimals: 18
										},
										rpcUrls: ['http://rpc.jnsdao.com:8502', 'https://rpc.jnsdao.com:8503'],
										blockExplorerUrls: ['https://jscan.jnsdao.com'],
									}] })
								.catch((error) => {
									console.error(`Error add chain: ${error.code}: ${error.message}`);
								});
						}
					});
			}
		}


		// for search box...
        function processRequest() {
             var requestStr = $("#query")[0].value.split('0x').join('');

            if (requestStr.length === 40) // if address?
              return goToAddrInfos('0x'+requestStr)
            else if(requestStr.length === 64) {
              if(/[0-9a-zA-Z]{64}?/.test(requestStr)) // if tx?
                return goToTxInfos('0x'+requestStr)
              else if(/[0-9]{1,7}?/.test(requestStr)) // if block hash?
                return goToBlockInfos(requestStr)
            }
			else if (requestStr.toLowerCase().match(/\.j$/)) // if jns?
				return goToJNSInfo(requestStr)
			else if(parseInt(requestStr) > 0) // if block number?
				return goToBlockInfos(parseInt(requestStr)) 

            alert('不知道如何处理 '+ requestStr)
        };

        function goToJNSInfo(requestStr) {
            location.hash = '/jns/'+requestStr;
        }

        function goToBlockInfos(requestStr) {
            location.hash = '/block/'+requestStr;
        }

        function goToAddrInfos(requestStr) {
            location.hash = '/address/'+requestStr;
        }

         function goToTxInfos (requestStr) {
             location.hash = '/tx/'+requestStr;
        }
	</script>
</head>
<body onload="onBodyLoaded()">
  
<nav class="navbar navbar-inverse navbar-fixed-top">
    <div class="container">
        <div class="navbar-header">
			<button class="navbar-toggle" type="button" data-toggle="collapse" data-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
			</button>
            <a href="/#/" class="navbar-brand">区块链浏览器</a>
        </div>
        <div id="navbar" class="navbar-collapse collapse">
            <ul class="nav navbar-nav">
            <form  name="search_form" onsubmit="processRequest()"  class="navbar-form navbar-right">
            <div class="form-group">
            <input type="text" placeholder="JNS域名/链地址/交易哈希/区块高度" name="requestType" required  id="query"  class="form-control"><br>
            </div>
            <button type="submit" class="btn btn-success">搜索</button></form>
            </ul>
			<ul class="nav navbar-nav navbar-right">
				<li id="connect" style="display:inline-block">
					<a id="connLink" style="cursor:pointer" onclick="connect()">
						<span id="connAddr"></span>
						[<span id="connNet">?</span>]
					</a>
				</li>
			</ul>
	    </div>
    </div>
</nav>

<div ng-view></div>

<!--Libs-->

  <script src="mirror/ajax/libs/angularjs/1.4.5/angular.min.js"></script>
  <script src="bower_components/angular-bootstrap/ui-bootstrap.min.js"></script>
  <script src="bower_components/angular-route/angular-route.js"></script>
  <script src="mirror/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
  <script src="mirror/bootstrap/3.3.5/js/bootstrap.min.js"></script>

<!--Misc-->
  <script src="scripts/misc/flyingj.sbt.js"></script>
  <script src="scripts/misc/jnsdaov.sbt.js"></script>
  <script src="scripts/misc/jns.nft.js"></script>
  <script src="scripts/misc/jnsvote.sbt.js"></script>
  <script src="scripts/misc/jti.sbt.js"></script>
  <script src="scripts/misc/airdrop.js"></script>

<!--Crypto-->
  <script src="scripts/crypto/bech32.js"></script>
  <script src="scripts/crypto/hex.js"></script>

<!--Core-->
  <script src="app.js"></script>

<!--Controllers-->
  <script src="scripts/controllers/mainController.js"></script>
  <script src="scripts/controllers/addressInfoController.js"></script>
  <script src="scripts/controllers/blockInfosController.js"></script>
  <script src="scripts/controllers/transactionInfosController.js"></script>
  <script src="scripts/controllers/jnsInfoController.js"></script>
  <script src="scripts/controllers/jnsVoteInfoController.js"></script>

  <!--Services-->
    <div id="connectwarning" class="modal fade" role="dialog">
        <div class="modal-dialog">

            <!-- Modal content-->
            <div class="modal-content">
                <center><div class="modal-header">
                    <h4 class="modal-title">无法连接到区块链网络</h4>
                </div>
                <div class="modal-body">
                    <code><p id="modaltext"></p></code>
                </div></center>
            </div>
        </div>
    </div>


<div class="footer" style="bottom: 0px;text-align: center;background-color: white; width:100%;">
    <footer>
        <hr>
        <p>
            <a href="http://blockcoach.com">blockcoach</a> open-sourced. no warranty.
        </p>
    </footer>
</div>
<script>
$("#modaltext").text( '无法连接到RPC服务，请检查你的网络连接是否畅通' );
</script>
</body>
</html>
